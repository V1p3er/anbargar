{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preload" href="{% static 'home/files/media/93f479601ee12b01-s.p.woff2' %}" as="font" crossorigin type="font/woff2" />
    <link rel="preload" href="{% static 'home/files/media/d7e4f6615a2c8129-s.p.ttf' %}" as="font" crossorigin type="font/ttf" />
    <link rel="stylesheet" href="{% static 'home/files/css/c7c4bf402424dcf5.css' %}" />
    <link rel="stylesheet" href="{% static 'home/files/css/0dee5438fe9be528.css' %}" />
    <link rel="icon" href="{% static 'home/files/favicon.ico' %}" type="image/x-icon" sizes="16x16" />
    <link rel="stylesheet" href="{% static 'home/files/css/dash.css'%}">
    <title>داشبورد | انبارگر</title>
  </head>

  <body class="__variable_a79634 __variable_9a8899 __className_a79634 antialiased font-iranyekan">
    <div class="dash-toast" id="toast"></div>

    <div class="app-shell">

      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="brand">
            <img src="{% static 'home/files/logo4cec.png' %}" alt="لوگوی انبارگر" width="44" height="44" class="object-contain" />
            <div>
              <div class="title">انبارگر</div>
              <div class="subtitle">داشبورد مدیریت انبار</div>
            </div>
          </div>
        </div>

        <nav class="sidebar-nav">
          <button class="nav-btn active" data-target="sec-dashboard" type="button">
            <span>داشبورد</span><span class="nav-pill">پیش‌فرض</span>
          </button>

          <button class="nav-btn" data-target="sec-stats" type="button">
            <span>آمار سریع</span><span class="nav-pill" id="pill-low">—</span>
          </button>

          <button class="nav-btn" data-target="sec-create" type="button">
            <span>ثبت‌ها</span><span class="nav-pill">انبار/کالا/واحد</span>
          </button>

          <button class="nav-btn" data-target="sec-customers-events" type="button">
            <span>مشتری و رویداد</span><span class="nav-pill">ورود/خروج/جابجایی</span>
          </button>

          <button class="nav-btn" data-target="sec-lists" type="button">
            <span>لیست‌ها</span><span class="nav-pill">انبار/کالا</span>
          </button>

          <button class="nav-btn" data-target="sec-more-lists" type="button">
            <span>لیست‌های بیشتر</span><span class="nav-pill">مشتری/واحد</span>
          </button>

          <button class="nav-btn" data-target="sec-inventory-events" type="button">
            <span>موجودی و رویدادها</span><span class="nav-pill">گزارش</span>
          </button>

          <button class="nav-btn" data-target="sec-ai-upload" type="button">
            <span>هوش مصنوعی و آپلود</span><span class="nav-pill">ابزار</span>
          </button>


          <button class="nav-btn" data-target="sec-receipt" type="button">
            <span>رسید</span><span class="nav-pill">چاپ/ذخیره</span>
          </button>
        </nav>

        <div class="sidebar-footer">
          <div class="dash-card p-4">
            <div class="text-sm text-gray-600">خوش آمدید، {{ display_name }}</div>
            <div class="mt-3 flex gap-2">
              <a href="{% url 'logout' %}" class="dash-button-outline w-full text-center">خروج</a>
            </div>
          </div>
        </div>
      </aside>

      <div class="content">
        <header class="topbar">
          <div>
            <div class="text-2xl font-extrabold text-gray-900">مرکز فرمان انبارگر</div>
            <div class="text-sm text-gray-500 mt-1">همه چیز یکجا: ثبت، موجودی، رویداد، پیش‌بینی</div>
          </div>

          <div class="flex items-center gap-2">
            <button class="mobile-toggle" id="mobileToggle" type="button">☰ منو</button>

            <div class="dash-card p-4 hidden md:block">
              <p class="text-xs text-gray-500">اتصال به API</p>
              <div class="mt-2 flex gap-2">
                <input id="token-input" class="dash-input text-xs" placeholder="توکن API" />
                <button id="token-apply" class="dash-button text-xs" type="button">فعال‌سازی</button>
              </div>
              <p class="text-xs text-gray-400 mt-2">توکن خودکار از نشست شما دریافت می‌شود.</p>
            </div>
          </div>
        </header>

        <main class="sections">


          <section id="sec-dashboard" class="section active">
            <div class="dash-card p-8">
              <div class="flex flex-wrap items-center justify-between gap-6">
                <div>
                  <p class="dash-chip inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold">داشبورد</p>
                  <h1 class="text-3xl lg:text-4xl font-bold mt-4">خلاصه وضعیت امروز</h1>
                  <p class="text-base text-gray-500 mt-3 max-w-2xl">
                    آخرین وضعیت موجودی، رویدادهای اخیر و چند اقدام سریع برای شروع.
                  </p>
                </div>
                <div class="dash-card p-5">
                  <p class="text-sm text-gray-500">اقدامات سریع</p>
                  <div class="mt-3 grid gap-2">
                    <button class="dash-button" type="button" data-jump="sec-customers-events">ثبت رویداد</button>
                    <button class="dash-button-outline" type="button" data-jump="sec-create">ثبت کالا/انبار</button>
                    <button class="dash-button-outline" type="button" data-jump="sec-receipt">ساخت رسید</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid gap-6 lg:grid-cols-3 mt-6">
              <div class="dash-card p-6 lg:col-span-2">
                <h2 class="dash-title text-lg font-semibold mb-4">اتفاقات اخیر</h2>
                <div id="dashboard-feed" class="space-y-3"></div>
                <div class="text-xs text-gray-400 mt-4">این بخش از داده‌های همین صفحه ساخته می‌شود.</div>
              </div>

              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">نشانگرهای مهم</h2>
                <div class="space-y-3">
                  <div class="dash-card p-4 border border-gray-100">
                    <div class="text-sm text-gray-500">هشدار کمبود</div>
                    <div class="text-2xl font-extrabold mt-1" data-stat="low_stock_count">{{ stats.low_stock_count }}</div>
                  </div>
                  <div class="dash-card p-4 border border-gray-100">
                    <div class="text-sm text-gray-500">ارزش موجودی</div>
                    <div class="text-2xl font-extrabold mt-1" data-stat="total_value">{{ stats.total_value|floatformat:0 }}</div>
                  </div>
                  <button class="dash-button w-full" type="button" data-jump="sec-stats">رفتن به آمار سریع</button>
                </div>
              </div>
            </div>
          </section>


          <section id="sec-stats" class="section">
            <section class="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
              <div class="dash-card p-6">
                <p class="text-sm text-gray-500">کل کالاها</p>
                <p class="text-2xl font-bold text-gray-900 mt-2" data-stat="total_items">{{ stats.total_items }}</p>
                <p class="text-xs text-gray-400 mt-2">تعاریف کالا در سیستم</p>
              </div>
              <div class="dash-card p-6">
                <p class="text-sm text-gray-500">کل انبارها</p>
                <p class="text-2xl font-bold text-gray-900 mt-2" data-stat="total_folders">{{ stats.total_folders }}</p>
                <p class="text-xs text-gray-400 mt-2">مکان‌های ثبت‌شده</p>
              </div>
              <div class="dash-card p-6">
                <p class="text-sm text-gray-500">ارزش موجودی</p>
                <p class="text-2xl font-bold text-gray-900 mt-2" data-stat="total_value">{{ stats.total_value|floatformat:0 }}</p>
                <p class="text-xs text-gray-400 mt-2">بر اساس ارزش کالا</p>
              </div>
              <div class="dash-card p-6">
                <p class="text-sm text-gray-500">هشدار کمبود</p>
                <p class="text-2xl font-bold text-gray-900 mt-2" data-stat="low_stock_count">{{ stats.low_stock_count }}</p>
                <p class="text-xs text-gray-400 mt-2">کالاهای نزدیک به اتمام</p>
              </div>
            </section>
          </section>

          <section id="sec-create" class="section">
            <section class="grid gap-6 lg:grid-cols-3">
              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">ثبت انبار</h2>
                <form id="folder-form" class="space-y-3">
                  <input class="dash-input" name="name" placeholder="نام انبار" required />
                  <textarea class="dash-textarea" name="description" rows="2" placeholder="توضیحات"></textarea>
                  <button class="dash-button w-full" type="submit">افزودن انبار</button>
                </form>
              </div>

              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">ثبت کالا</h2>
                <form id="item-form" class="space-y-3">
                  <input class="dash-input" name="name" placeholder="نام کالا" required />
                  <input class="dash-input" name="sku" placeholder="کد SKU (اختیاری)" />
                  <input class="dash-input" name="barcode" placeholder="بارکد (اختیاری)" />
                  <input class="dash-input" name="value" type="number" step="0.01" placeholder="ارزش کالا" />
                  <textarea class="dash-textarea" name="description" rows="2" placeholder="توضیحات"></textarea>
                  <label class="flex items-center gap-2 text-sm text-gray-600">
                    <input type="checkbox" name="has_qr_code" />
                    فعال‌سازی QR Code
                  </label>
                  <button class="dash-button w-full" type="submit">افزودن کالا</button>
                </form>
              </div>

              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">ثبت واحد</h2>
                <form id="unit-form" class="space-y-3">
                  <input class="dash-input" name="name" placeholder="نام واحد" required />
                  <input class="dash-input" name="symbol" placeholder="نماد (مثلا عدد، عددی)" required />
                  <textarea class="dash-textarea" name="description" rows="2" placeholder="توضیحات"></textarea>
                  <button class="dash-button w-full" type="submit">افزودن واحد</button>
                </form>
              </div>
            </section>
          </section>

          <section id="sec-customers-events" class="section">
            <section class="grid gap-6 lg:grid-cols-3">
              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">ثبت مشتری</h2>
                <form id="customer-form" class="space-y-3">
                  <input class="dash-input" name="first_name" placeholder="نام" required />
                  <input class="dash-input" name="last_name" placeholder="نام خانوادگی" />
                  <input class="dash-input" name="phone" placeholder="شماره تماس" />
                  <input class="dash-input" name="email" placeholder="ایمیل" />
                  <textarea class="dash-textarea" name="address" rows="2" placeholder="آدرس"></textarea>
                  <button class="dash-button w-full" type="submit">افزودن مشتری</button>
                </form>
              </div>

              <div class="dash-card p-6 lg:col-span-2">
                <h2 class="dash-title text-lg font-semibold mb-4">ثبت رویداد انبار (ورود، خروج، جابه‌جایی)</h2>
                <form id="event-form" class="space-y-4">
                  <div class="grid gap-3 md:grid-cols-3">
                    <div>
                      <label class="text-sm text-gray-600">نوع رویداد</label>
                      <select class="dash-select" name="type" id="event-type">
                        <option value="BUY">ورود (خرید)</option>
                        <option value="SELL">خروج (فروش)</option>
                        <option value="MOVE">جابه‌جایی</option>
                      </select>
                    </div>
                    <div>
                      <label class="text-sm text-gray-600">توضیح</label>
                      <input class="dash-input" name="description" placeholder="توضیح کوتاه" />
                    </div>
                    <div>
                      <label class="text-sm text-gray-600">مشتری (اختیاری)</label>
                      <select class="dash-select" id="event-customer-select">
                        <option value="">انتخاب مشتری</option>
                      </select>
                    </div>
                  </div>

                  <div class="grid gap-3 md:grid-cols-3" id="event-folder-row">
                    <div>
                      <label class="text-sm text-gray-600">انبار</label>
                      <select class="dash-select" name="folder_id" id="event-folder">
                        <option value="">انتخاب انبار</option>
                      </select>
                    </div>
                    <div>
                      <label class="text-sm text-gray-600">نام مشتری</label>
                      <input class="dash-input" name="customer_name" placeholder="نام مشتری" />
                    </div>
                    <div>
                      <label class="text-sm text-gray-600">شماره مشتری</label>
                      <input class="dash-input" name="customer_phone" placeholder="شماره تماس" />
                    </div>
                  </div>

                  <div class="grid gap-3 md:grid-cols-2 hidden" id="event-move-row">
                    <div>
                      <label class="text-sm text-gray-600">انبار مبدا</label>
                      <select class="dash-select" name="origin_folder_id" id="event-origin">
                        <option value="">انتخاب مبدا</option>
                      </select>
                    </div>
                    <div>
                      <label class="text-sm text-gray-600">انبار مقصد</label>
                      <select class="dash-select" name="destination_folder_id" id="event-destination">
                        <option value="">انتخاب مقصد</option>
                      </select>
                    </div>
                  </div>

                  <textarea class="dash-textarea" name="customer_address" rows="2" placeholder="آدرس مشتری (برای فروش)"></textarea>

                  <div class="space-y-3">
                    <div class="flex items-center justify-between">
                      <h3 class="text-sm font-semibold text-gray-700">اقلام رویداد</h3>
                      <button class="dash-button-outline text-xs" type="button" id="add-item-row">افزودن ردیف</button>
                    </div>
                    <div id="event-items" class="space-y-3"></div>
                  </div>

                  <button class="dash-button w-full" type="submit">ثبت رویداد</button>
                </form>
              </div>
            </section>
          </section>


          <section id="sec-lists" class="section">
            <section class="grid gap-6 lg:grid-cols-2">
              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">لیست انبارها</h2>
                <div class="overflow-auto">
                  <table class="dash-table w-full text-sm" id="folders-table">
                    <thead><tr><th>نام</th><th>توضیحات</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">لیست کالاها</h2>
                <div class="overflow-auto">
                  <table class="dash-table w-full text-sm" id="items-table">
                    <thead><tr><th>نام</th><th>بارکد</th><th>ارزش</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>
          </section>


          <section id="sec-more-lists" class="section">
            <section class="grid gap-6 lg:grid-cols-2">
              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">لیست مشتریان</h2>
                <div class="overflow-auto">
                  <table class="dash-table w-full text-sm" id="customers-table">
                    <thead><tr><th>نام</th><th>شماره</th><th>ایمیل</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">لیست واحدها</h2>
                <div class="overflow-auto">
                  <table class="dash-table w-full text-sm" id="units-table">
                    <thead><tr><th>نام</th><th>نماد</th><th>توضیحات</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>
          </section>

          <section id="sec-inventory-events" class="section">
            <section class="grid gap-6 lg:grid-cols-2">
              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">موجودی انبار</h2>
                <div class="overflow-auto">
                  <table class="dash-table w-full text-sm" id="inventory-table">
                    <thead><tr><th>کالا</th><th>انبار</th><th>تعداد</th><th>واحد</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">رویدادهای ثبت شده</h2>
                <div class="overflow-auto">
                  <table class="dash-table w-full text-sm" id="events-table">
                    <thead><tr><th>نوع</th><th>توضیح</th><th>زمان</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </section>
          </section>

          <section id="sec-ai-upload" class="section">
            <section class="grid gap-6 lg:grid-cols-2">
              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">پیش‌بینی هوشمند موجودی</h2>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                  <input class="dash-input w-32" id="ai-days" type="number" value="30" min="1" />
                  <button class="dash-button" id="ai-run" type="button">محاسبه پیش‌بینی</button>
                  <span class="text-xs text-gray-400">روز گذشته</span>
                </div>
                <div class="overflow-auto">
                  <table class="dash-table w-full text-sm" id="ai-table">
                    <thead><tr><th>کالا</th><th>موجودی</th><th>میانگین فروش</th><th>روز باقی‌مانده</th><th>پیشنهاد</th></tr></thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>

              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">آپلود فایل</h2>
                <form id="upload-form" class="space-y-3">
                  <input type="file" id="upload-file" class="dash-input" />
                  <button class="dash-button w-full" type="submit">آپلود</button>
                  <div class="text-xs text-gray-500">
                    آدرس فایل: <span id="upload-url" style="color:var(--accent);font-weight:800"></span>
                  </div>
                  <img id="upload-preview" class="rounded-xl hidden" alt="پیش‌نمایش" />
                </form>
              </div>
            </section>
          </section>

          <section id="sec-receipt" class="section">
            <div class="grid gap-6 lg:grid-cols-3">
              <div class="dash-card p-6">
                <h2 class="dash-title text-lg font-semibold mb-4">ساخت رسید</h2>

                <div class="space-y-3">
                  <div>
                    <label class="text-sm text-gray-600">انتخاب رویداد</label>
                    <select id="receipt-event-select" class="dash-select">
                      <option value="">انتخاب رویداد...</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2">فقط رویدادهای ورود/خروج نمایش داده می‌شوند.</p>
                  </div>

                  <div class="dash-card p-4 border border-gray-100">
                    <div class="text-sm text-gray-600 font-semibold mb-2">نوع رسید</div>
                    <label class="flex items-center gap-2 text-sm text-gray-700">
                      <input type="radio" name="receipt-kind" value="seller" checked />
                      رسید فروش (برای خروج)
                    </label>
                    <label class="flex items-center gap-2 text-sm text-gray-700 mt-2">
                      <input type="radio" name="receipt-kind" value="buyer" />
                      رسید خرید (برای ورود)
                    </label>
                    <p class="text-xs text-gray-400 mt-2">می‌توانید برای هر رویداد رسید دلخواه بسازید.</p>
                  </div>

                  <div class="grid grid-cols-2 gap-2">
                    <button class="dash-button" id="receipt-generate" type="button">ساخت رسید</button>
                    <button class="dash-button-outline" id="receipt-clear" type="button">پاک کردن</button>
                  </div>

                  <div class="grid grid-cols-2 gap-2">
                    <button class="dash-button-outline" id="receipt-save-local" type="button">ذخیره در مرورگر</button>
                    <button class="dash-button-outline" id="receipt-download" type="button">دانلود HTML</button>
                  </div>

                  <button class="dash-button w-full" id="receipt-print" type="button">چاپ (Print)</button>
                </div>
              </div>

              <div class="dash-card p-6 lg:col-span-2">
                <h2 class="dash-title text-lg font-semibold mb-4">پیش‌نمایش رسید</h2>
                <div id="receipt-preview" class="dash-card p-4 border border-gray-100" style="overflow:auto; min-height: 420px;">
                  <div class="text-sm text-gray-400">هنوز رسیدی ساخته نشده است.</div>
                </div>

                <div class="mt-6">
                  <h3 class="text-sm font-semibold text-gray-700 mb-3">رسیدهای ذخیره‌شده در مرورگر</h3>
                  <div id="receipt-saved-list" class="space-y-2"></div>
                </div>
              </div>
            </div>
          </section>

        </main>
      </div>
    </div>

    <datalist id="units-list"></datalist>

    <template id="event-item-template">
      <div class="dash-card p-4 border border-gray-100 item-row">
        <div class="grid gap-3 md:grid-cols-7 items-end">
          <div class="md:col-span-2">
            <label class="text-xs text-gray-500">کالای موجود</label>
            <select class="dash-select" data-field="item">
              <option value="">انتخاب کالا</option>
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="text-xs text-gray-500">نام کالا</label>
            <input class="dash-input" data-field="name" placeholder="نام کالا" />
          </div>
          <div>
            <label class="text-xs text-gray-500">تعداد</label>
            <input class="dash-input" data-field="quantity" type="number" step="0.01" />
          </div>
          <div>
            <label class="text-xs text-gray-500">واحد</label>
            <input class="dash-input" data-field="unit" list="units-list" />
          </div>
          <div>
            <label class="text-xs text-gray-500">ارزش</label>
            <input class="dash-input" data-field="value" type="number" step="0.01" />
          </div>
          <div class="text-left">
            <button class="dash-button-outline text-xs" type="button" data-action="remove-row">حذف</button>
          </div>
        </div>
      </div>
    </template>
    <script src="{% static 'home/files/dash.js' %}"></script>
  </body>
</html>